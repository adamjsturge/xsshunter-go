<!DOCTYPE html>
<html>
<head>
    <title>Admin Page</title>
    <style>
        /* General table styles for a cleaner look */
        table, th, td {
            border-collapse: collapse; /* Removes double borders */
            border: 1px solid #ddd; /* Lighter border color */
        }

        th, td {
            padding: 10px; /* More spacious padding */
            text-align: left; /* Align text to the left for readability */
        }

        /* Modal styling for a more modern appearance */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            display: flex; /* Centering the modal content */
            align-items: center;
            justify-content: center;
        }

        .modal_div {
            background-color: white;
            margin: auto;
            padding: 20px;
            width: 60%; /* Adjusted width for better focus */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Softer shadow for depth */
            overflow: hidden; /* Ensures no overflow of child elements */
        }

        .action_button {
            background-color: #007bff; /* Blue button color */
            color: white; /* White text for better contrast */
            padding: 10px; /* More spacious padding */
            border: none; /* No border for a cleaner look */
            border-radius: 5px; /* Rounded corners for a modern appearance */
            cursor: pointer; /* Pointer cursor for better usability */
        }

        .action_button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }

        .close_button {
            background-color: #dc3545; /* Red button color */
            color: white; /* White text for better contrast */
            padding: 10px; /* More spacious padding */
            border: none; /* No border for a cleaner look */
            border-radius: 5px; /* Rounded corners for a modern appearance */
            cursor: pointer; /* Pointer cursor for better usability */
        }

        .close_button:hover {
            background-color: #c82333; /* Darker red on hover */
        }

        /* Table header styles with a subtle gradient */
        .payload_fires_header {
            background: linear-gradient(to right, #f8f9fa, #e9ecef); /* Subtle gradient */
            color: #495057; /* Darker text for better contrast */
        }

        .payload_fires_title_cell {
            font-weight: bold;
        }

        /* Alternating row colors for readability */
        .payload_fires_row:nth-child(odd) {
            background-color: #fefefe;
        }

        .payload_fires_row:nth-child(even) {
            background-color: #f1f3f5;
        }

        .payload_fires_cell {
            padding: 10px; /* Consistent padding with header */
            border-bottom: 1px solid #dee2e6; /* Lighter border for separation */
        }

        .thumbnail {
            width: 100px;
            height: 100px;
        }

    </style>
</head>
<body>
    <h1>Admin Page</h1>
    <table class="payload_fires_table" id="payloadFiresTable">
        <tr class="payload_fires_header">
            <th class="payload_fires_title_cell">ID</th>
            <th class="payload_fires_title_cell">Image</th>
            <th class="payload_fires_title_cell">URI</th>
            <th class="payload_fires_title_cell">Expand</th>
        </tr>
    </table>
    <script>
        function loadPayloadFires() {
            var page = 1;
            var limit = 10;
            fetch(`/api/v1/payloadfires?page=${page}&limit=${limit}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('payloadFiresTable');
                data.forEach(item => {
                    const row = make_table_row(table, 'payload_fires_row');
                    make_table_cell(item.id, row, 'payload_fires_cell');
                    make_table_cell(item.url, row, 'payload_fires_cell');
                    make_table_cell(null, row, 'payload_fires_cell').appendChild(make_image(item.screenshot_id, 'Screenshot', null, 'thumbnail'));
                    const actionCell = make_table_cell(null, row, 'payload_fires_cell');
                    make_element('button', 'Expand', actionCell, 'action_button', function() {
                        expandPayloadFire(item);
                    });
                });
            });
        }

        function expandPayloadFire(payloadFire) {
            const modal = make_modal('modal');

            const modalContent = make_div('modal_div', modal);

            make_element('h2', 'Payload Fire', modalContent);

            make_element('p', `ID: ${payloadFire.id}`, modalContent);
            make_element('p', `URL: ${payloadFire.url}`, modalContent);
            make_element('p', `IP Address: ${payloadFire.ip_address}`, modalContent);
            make_element('p', `Referer: ${payloadFire.referer}`, modalContent);
            make_element('p', `User Agent: ${payloadFire.user_agent}`, modalContent);
            make_element('p', `Cookies: ${payloadFire.cookies}`, modalContent);
            make_element('p', `Title: ${payloadFire.title}`, modalContent);
            make_element('p', `DOM: ${payloadFire.dom}`, modalContent);
            make_element('p', `Text: ${payloadFire.text}`, modalContent);
            make_element('p', `Origin: ${payloadFire.origin}`, modalContent);
            make_image(payloadFire.screenshot_id, 'Screenshot', modalContent);
            // make_element('p', `Screenshot ID: ${payloadFire.screenshot_id}`, modalContent);
            make_element('p', `Was Iframe: ${payloadFire.was_iframe}`, modalContent);
            make_element('p', `Browser Timestamp: ${payloadFire.browser_timestamp}`, modalContent);
            make_element('p', `Correlated Request: ${payloadFire.correlated_request}`, modalContent);

            make_element('button', 'Close', modalContent, 'close_button', modal.remove.bind(modal));

            document.body.appendChild(modal);
        }

        function deletePayloadFire(id) {
            console.log('deletePayloadFire', id)
            // var form_data = new FormData();
            // form_data.append("ids", id);

            // fetch('/api/v1/payloadfires', {
            //     method: 'DELETE',
            //     body: form_data
            // })
            // .then(() => {
            //     // Reload the page to get the updated list
            //     location.reload();
            // });
        }

        function loadCollectedPages() {
            fetch('/api/v1/collected_pages', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('pagesTable');
                data.forEach(item => {
                    const row = table.insertRow();
                    const idCell = row.insertCell();
                    const uriCell = row.insertCell();
                    const actionCell = row.insertCell();

                    idCell.textContent = item.id;
                    uriCell.textContent = item.uri;

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = function() {
                        deleteCollectedPage(item.id);
                    };
                    actionCell.appendChild(deleteButton);
                });
            });
        }

        function deleteCollectedPage(id) {
            var form_data = new FormData();
            form_data.append("ids", id);

            fetch('/api/v1/collected_pages', {
                method: 'DELETE',
                body: form_data
            })
            .then(() => {
                // Reload the page to get the updated list
                location.reload();
            });
        }

        // Load the collected pages when the page loads
        window.onload = loadPayloadFires;
    </script>

    <script>
        function make_element(tag, text = null, parent = null, style_class = null, onclick_function = null) {
            var element = document.createElement(tag);
            element.textContent = text;
            if (style_class) {
                element.className = style_class;
            }
            if (onclick_function) {
                element.onclick = onclick_function;
            }
            if (parent) {
                parent.appendChild(element);
            }
            return element;
        }

        function make_image(src, alt, parent = null, style_class = null) {
            var image = document.createElement('img');
            image.src = `/screenshots/${src}.png`;
            image.alt = alt;
            if (style_class) {
                image.className = style_class;
            }
            if (parent) {
                parent.appendChild(image);
            }
            return image;
        }

        function make_modal(style_class) {
            var modal = make_element('div', null, null, style_class);
            return modal;
        }

        function make_div(style_class, parent = null) {
            var div = make_element('div', null, parent, style_class);
            return div;
        }

        function make_table(style_class, parent = null) {
            var table = make_element('table', null, parent);
            return table;
        }

        function make_table_row(table, style_class = null) {
            var row = table.insertRow();
            if (style_class) {
                row.className = style_class;
            }
            return row;
        }

        function make_table_cell(text, row, style_class = null) {
            var cell = row.insertCell();
            cell.textContent = text;
            if (style_class) {
                cell.className = style_class;
            }
            return cell;
        }
    </script>
</body>
</html>